name: Deploy to Starfree Server

on:
  push:
    branches:
      - main

jobs:
  fetch-ftp:
    runs-on: ubuntu-latest
    outputs:
      conflict: ${{ steps.diff_check.outputs.conflict }}  # ã“ã“ã§ `conflict` ã‚’ã‚¸ãƒ§ãƒ–é–“ã§å…±æœ‰
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install lftp
        run: sudo apt-get install -y lftp

      - name: Fetch latest files from FTP before deploying
        run: |
          lftp -c "
          open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }};
          mirror --verbose --only-newer --parallel=2 /kasukou2025.stars.ne.jp/public_html ./ftp_latest/
          bye"
        shell: bash

      - name: Compare local and FTP files
        id: diff_check
        run: |
          mkdir -p ./ftp_backup
          cp -r ./ftp_latest/* ./ftp_backup/

          # æ¯”è¼ƒç”¨ã®diffãƒ­ã‚°ä½œæˆ
          diff -rq ./ftp_backup/ ./public_html/ > diff_log.txt || true

          if [ -s diff_log.txt ]; then
            echo "conflict=true" >> $GITHUB_ENV
            echo "conflict=true" >> $GITHUB_OUTPUT
            echo "ğŸš¨ ç«¶åˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚GitHubä½œæ¥­è€…ãŒè§£æ±ºã—ã¦ãã ã•ã„ã€‚"
          else
            echo "conflict=false" >> $GITHUB_ENV
            echo "conflict=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit FTP changes to a new branch if conflicts exist
        if: steps.diff_check.outputs.conflict == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"

          BRANCH_NAME="ftp-conflict-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          cp -r ./ftp_backup/* ./public_html/
          git add .
          git commit -m "FTP å¤‰æ›´ã‚’ãƒãƒ¼ã‚¸ã€‚æ‰‹å‹•ã§ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ±ºã—ã¦ãã ã•ã„ã€‚"
          git push origin $BRANCH_NAME
          echo "::error::ğŸš¨ ç«¶åˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦æ‰‹å‹•ã§è§£æ±ºã—ã¦ãã ã•ã„ã€‚"

      - name: Create Pull Request if conflicts exist
        if: steps.diff_check.outputs.conflict == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          branch: ${{ github.ref_name }}
          title: "ğŸš¨ FTPå¤‰æ›´ã¨ã®ç«¶åˆã‚’è§£æ±ºã—ã¦ãã ã•ã„"
          body: |
            ğŸš¨ FTPã§ç›´æ¥ç·¨é›†ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨GitHubã®å¤‰æ›´ãŒç«¶åˆã—ã¦ã„ã¾ã™ã€‚
            `diff_log.txt` ã«ç«¶åˆãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã™ã€‚
            æ‰‹å‹•ã§ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ¶ˆã—ã€ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚

  deploy:
    needs: fetch-ftp
    if: needs.fetch-ftp.outputs.conflict == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.5
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./public_html/
          server-dir: /kasukou2025.stars.ne.jp/public_html
          only-newer: true
