name: Deploy to Starfree Server

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  fetch-ftp:
    runs-on: ubuntu-latest

    outputs:
      conflict: ${{ steps.diff_check.outputs.conflict }}

    steps:
      # (1) GitHubリポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # 差分コミット時に履歴の制限でエラーが出ないようにする
          fetch-depth: 0

      # (2) lftpインストール
      - name: Install lftp
        run: sudo apt-get install -y lftp

      # (3) FTPファイルをダウンロード (public_html/ の中身だけ)
      - name: Fetch latest files from FTP
        run: |
          lftp -c "
          open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }};
          mirror --verbose --only-newer --parallel=2 /kasukou2025.stars.ne.jp/public_html/ ./ftp_latest/
          bye"
        shell: bash

      # (4) 差分比較
      - name: Compare local and FTP files
        id: diff_check
        run: |
          # 内容ベースで dry-run 比較 (checksum + 再帰 + delete)
          rsync -rcn --delete ./ftp_latest/ ./public_html/ > diff_log.txt || true

          # diff_log.txt に何か出力があれば「実質差分あり」
          if [ -s diff_log.txt ]; then
            echo "conflict=true" >> $GITHUB_OUTPUT
          else
            echo "conflict=false" >> $GITHUB_OUTPUT
          fi

      - name: Debug diff log
        if: steps.diff_check.outputs.conflict == 'true'
        run: cat diff_log.txt



      # (5) 差分がある場合、ブランチを作成（差分がGit的にあった場合のみコミット）
      - name: Commit FTP changes to a new branch if conflicts exist
        id: commit_ftp
        if: steps.diff_check.outputs.conflict == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"

          DATE_STR=$(date '+%Y%m%d-%H%M%S')
          BRANCH_NAME="ftp-conflict-${DATE_STR}"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

          git checkout -b "$BRANCH_NAME"
          cp -r ./ftp_latest/* ./public_html/ || true

          git add .
          if ! git diff --cached --quiet; then
            git commit -m "FTPのファイルを取り込み (${DATE_STR})。手動で不要ファイルの整理・コンフリクトを解消してください。"
            git push origin "$BRANCH_NAME"
            echo "pushed=true" >> "$GITHUB_OUTPUT"
          else
            echo "差分がないため、コミットとPushをスキップします。"
            echo "pushed=false" >> "$GITHUB_OUTPUT"
          fi

      # (6) PRは push が実際に行われた場合のみ作成する
      - name: Create Pull Request if conflicts exist
        if: steps.commit_ftp.outputs.pushed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.commit_ftp.outputs.branch_name }}
          base: main
          title: "FTPとの差分あり。不要ファイルを整理・マージしてください"
          body: |
            FTP上のファイルとGitHub上の`public_html`に差分が見つかりました。
            `diff_log.txt` を確認のうえ、不要ファイルの整理・マージをお願いします。




  # (7) 競合がない場合はそのまま自動デプロイ
  deploy:
    needs: fetch-ftp
    if: needs.fetch-ftp.outputs.conflict == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./public_html/
          server-dir: /kasukou2025.stars.ne.jp/public_html/

